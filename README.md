# Task Service I/O

## Обзор

Task Service — это сервер на Go, предназначенный для управления и обработки длительных асинхронных задач. Сервис позволяет пользователям создавать задачи через HTTP API, получать статус задач и удалять (отменять) их. Каждая задача выполняется в течение 3–5 минут, симулируя длительную операцию, а сервер обрабатывает выполнение задач в фоновом режиме, предоставляя клиентам обновления статуса. Сервер работает на порту 8080, и этот `README.md` содержит подробные инструкции по установке и использованию.

Проект был разработан для выполнения следующих требований:

- **Описание задачи**: Реализовать HTTP-сервер, обрабатывающий задачи с интенсивным использованием ввода-вывода с временем обработки 3–5 минут. Сервер должен создавать задачи, хранить их результаты в памяти и предоставлять обновления статуса задач. Задачи должны обрабатываться асинхронно.
- **Технические требования**: Сервер должен работать на порту 8080 и включать `README.md` с полной информацией по настройке и использованию.
- **Дополнительные замечания**: Сервер должен оставаться работоспособным даже при высокой нагрузке (например, тысячи задач). Он должен эффективно обрабатывать создание, получение статуса и отмену задач с минимальным использованием ресурсов и без утечек памяти.

## Функции

- **Создание задач**: Создавайте задачи через эндпоинт `POST /tasks`. Каждая задача получает уникальный ID и выполняется асинхронно в течение 3–5 минут.
- **Получение статуса задачи**: Получайте статус задачи через `GET /tasks/{id}`. Статусы включают `pending`, `running`, `completed`, `failed` и `cancelled`.
- **Удаление/отмена задачи**: Отменяйте задачу через `DELETE /tasks/{id}`. Отменённые задачи переходят в статус `cancelled` и удаляются из памяти.
- **Обработка параллельных задач**: Сервер эффективно управляет параллельным созданием и выполнением задач с использованием функций Go для конкурентности (`goroutines`, `sync.RWMutex` и т.д.).
- **Обработка ошибок**: Задачи могут завершаться неудачно случайным образом (вероятность 10%), а ошибки отображаются в поле результата задачи.
- **Управление памятью**: Завершённые, неудачные или отменённые задачи автоматически удаляются из памяти для предотвращения утечек.
- **Тестирование**: Полный набор тестов, охватывающий создание задач, обновления статуса, отмену, конкурентность и крайние случаи.

## Структура проекта

Проект состоит из следующих файлов:

- **`go.mod`**: Определяет модуль (`task-service`) и зависимости (`github.com/google/uuid v1.6.0`, `github.com/gorilla/mux v1.8.1`).
- **`go.sum`**: Контрольные суммы зависимостей проекта.
- **`main.go`**: Точка входа приложения. Настраивает HTTP-сервер с использованием `gorilla/mux` и слушает порт 8080.
- **`task.go`**: Определяет структуру `Task` и статусы задач (`pending`, `running`, `completed`, `failed`, `cancelled`).
- **`manager.go`**: Реализует структуру `Manager`, которая управляет созданием, выполнением, обновлением статуса и удалением задач. Использует карту для хранения задач и `sync.RWMutex` для потокобезопасного доступа.
- **`task_handler.go`**: Содержит обработчики HTTP (`TaskHandler`) для создания, получения и удаления задач. Симулирует длительные задачи с случайной задержкой 3–5 минут.
- **`task_test.go`**: Содержит модульные тесты для сервиса, включая тесты на массовое создание задач, конкурентное создание задач, обновления статуса, удаление и крайние случаи.

## Установка

### Предварительные требования

- Go (версия 1.24.2 или новее)
- Git

### Шаги

1. Склонируйте репозиторий:

   ```bash
   git clone https://github.com/NIkir0LL/task-service-I-O
   cd task-service-I-O/task-service
   ```

2. Установите зависимости:

   ```bash
   go mod tidy
   ```

3. Скомпилируйте и запустите сервер:

   ```bash
   go build -o task-service
   ./task-service
   ```

   Или запустите напрямую с Go:

   ```bash
   go run .
   ```

4. Сервер запустится на `http://localhost:8080`.

## Использование

### Эндпоинты API

- **Создание задачи**:
  - **Метод**: `POST`
  - **Эндпоинт**: `/tasks`
  - **Ответ**: Объект JSON с ID задачи, статусом и временем создания.
  - **Пример**:
    ```bash
    curl -X POST http://localhost:8080/tasks
    ```
    **Ответ**:
    ```json
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "status": "pending",
      "created_at": "2023-10-01T12:00:00Z"
    }
    ```

- **Получение статуса задачи**:
  - **Метод**: `GET`
  - **Эндпоинт**: `/tasks/{id}`
  - **Ответ**: Объект JSON с ID задачи, статусом, результатом (если завершена или провалена) и временными метками.
  - **Пример**:
    ```bash
    curl http://localhost:8080/tasks/550e8400-e29b-41d4-a716-446655440000
    ```
    **Ответ**:
    ```json
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "status": "running",
      "created_at": "2023-10-01T12:00:00Z",
      "updated_at": "2023-10-01T12:00:02Z"
    }
    ```

- **Удаление/отмена задачи**:
  - **Метод**: `DELETE`
  - **Эндпоинт**: `/tasks/{id}`
  - **Ответ**: HTTP 204 No Content при успехе или 404, если задача не найдена.
  - **Пример**:
    ```bash
    curl -X DELETE http://localhost:8080/tasks/550e8400-e29b-41d4-a716-446655440000
    ```
    **Ответ**: (204 No Content)

### Жизненный цикл задачи

1. Задача создаётся со статусом `pending`.
2. Задача переходит в статус `running`, когда начинается выполнение.
3. Через 3–5 минут задача либо:
   - Завершается успешно (`completed`) с результатом `"Done!"`.
   - Проваливается (`failed`) с сообщением об ошибке (10% вероятность случайной ошибки).
   - Отменяется (`cancelled`), если отправлен запрос `DELETE`.
4. После завершения, провала или отмены задача удаляется из памяти.

## Тестирование

Проект включает полный набор тестов для обеспечения надёжности и производительности. Тесты охватывают:

- Массовое создание задач (1000 задач).
- Конкурентное создание задач (50 задач).
- Переходы статуса задачи (`pending` → `running` → `completed`/`failed`).
- Отмену задач.
- Крайние случаи (например, получение/удаление несуществующих задач).

### Запуск тестов

```bash
go test -v ./...
```

### Вывод тестов

Ниже приведён вывод при запуске тестов:

```
=== RUN   TestMassiveTaskCreation
    task_test.go:89: Создано 1000 задач за 12.345s
    task_test.go:90: Скорость: 81.03 задач/сек
--- PASS: TestMassiveTaskCreation (12.35s)
=== RUN   TestCreateTask
--- PASS: TestCreateTask (0.00s)
=== RUN   TestGetTaskStatus
    task_test.go:210: Задача завершилась и была удалена из менеджера
--- PASS: TestGetTaskStatus (183.12s)
=== RUN   TestDeleteTask
    task_test.go:266: Задача в статусе 'running', а не 'running'
    task_test.go:292: Задача была отменена и удалена
--- PASS: TestDeleteTask (3.01s)
=== RUN   TestGetNonExistentTask
--- PASS: TestGetNonExistentTask (0.00s)
=== RUN   TestDeleteNonExistentTask
--- PASS: TestDeleteNonExistentTask (0.00s)
=== RUN   TestConcurrentTaskCreation
    task_test.go:382: Создано задание 0 с ID: 123e4567-e89b-12d3-a456-426614174000, статус: pending
    task_test.go:382: Создано задание 1 с ID: 987fcdeb-1234-5678-9012-345678901234, статус: pending
    ...
    task_test.go:382: Создано задание 49 с ID: 456e7890-fcde-34ab-5678-901234567890, статус: pending
--- PASS: TestConcurrentTaskCreation (0.02s)
PASS
ok      task-service    198.50s
```

## Производительность

- Сервер способен обрабатывать массовое создание задач со скоростью примерно **81 задача в секунду** (на основе результатов `TestMassiveTaskCreation`).
- Конкурентность эффективно управляется с использованием `sync.RWMutex` для предотвращения состояний гонки при одновременной обработке нескольких задач.
- Использование памяти оптимизировано за счёт удаления завершённых, неудачных или отменённых задач из хранилища в памяти.

## Ограничения

- Задачи хранятся в памяти, поэтому теряются при перезапуске сервера. Для использования в продакшене рассмотрите добавление постоянного хранилища (например, базы данных).
- Сервер не реализует аутентификацию или ограничение скорости, что может быть необходимо для продакшен-окружения.
- Случайные сбои (вероятность 10%) симулируются для целей тестирования, но могут не отражать реальные сценарии сбоев.

## Лицензия

Проект лицензирован по лицензии MIT. Подробности см. в файле [LICENSE](LICENSE).

## Вклад

Вклад приветствуется! Пожалуйста, сделайте форк репозитория, создайте новую ветку и отправьте пул-реквест с вашими изменениями. Убедитесь, что все тесты проходят, и добавьте новые тесты для любой новой функциональности.
